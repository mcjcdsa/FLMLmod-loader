# 启动验证机制说明

## 概述

为了确保游戏只能通过官方启动器启动，系统实现了基于令牌的启动验证机制。直接运行游戏核心JAR文件将被拒绝。

## 工作原理

### 1. 令牌生成（启动器）

启动器在启动游戏时生成一个临时验证令牌：

```java
String launchToken = LaunchTokenGenerator.generateToken();
```

令牌格式：`timestamp:hash`
- `timestamp`: 当前时间戳（毫秒）
- `hash`: 基于共享密钥和时间戳的SHA-256哈希值

### 2. 令牌传递

启动器通过命令行参数将令牌传递给游戏核心：

```bash
java -jar game-core.jar --launchToken <token> ...
```

### 3. 令牌验证（游戏核心）

游戏核心在启动时验证令牌：

1. 检查令牌是否存在
2. 解析令牌格式（timestamp:hash）
3. 验证令牌是否过期（默认有效期5分钟）
4. 重新计算哈希值并比较

如果验证失败，游戏将拒绝启动并显示错误信息。

## 安全特性

### 1. 时间戳验证

令牌包含时间戳，确保：
- 令牌有时效性（5分钟有效期）
- 防止令牌被重复使用
- 防止令牌被长期保存

### 2. 哈希验证

令牌使用SHA-256哈希，确保：
- 令牌不能被伪造
- 令牌与时间戳绑定
- 共享密钥保密性

### 3. 共享密钥

启动器和游戏核心使用相同的共享密钥：
```java
private static final String SECRET_KEY = "FreedomLand_Official_Launcher_v1.0.0_SecretKey";
```

**注意**：在生产环境中，应该：
- 使用更复杂的密钥
- 定期更新密钥
- 避免密钥硬编码（考虑使用配置文件或环境变量）

## 错误处理

如果验证失败，游戏将显示：

```
========================================
  错误: 未通过启动验证
========================================

游戏只能通过官方启动器启动！

请使用以下方式启动游戏：
  1. 双击运行: 运行游戏.bat
  2. 或运行启动器: java -jar Launcher/target/freedomland-launcher-1.0.0-jar-with-dependencies.jar

禁止直接运行游戏核心JAR文件！
========================================
```

然后退出程序（退出码：1）。

## 配置文件

如果需要绕过验证（仅用于开发/调试），可以在配置文件中添加：

```json
{
  "launchToken": "bypass"
}
```

**注意**：这需要在代码中添加开发模式的检查，不建议在生产环境使用。

## 实现文件

- **启动器令牌生成器**: `Launcher/src/main/java/com/freedomland/launcher/LaunchTokenGenerator.java`
- **游戏核心验证器**: `GameCore/src/main/java/com/freedomland/game/LauncherVerifier.java`
- **启动逻辑**: `Launcher/src/main/java/com/freedomland/launcher/LauncherMain.java`
- **游戏入口**: `GameCore/src/main/java/com/freedomland/game/GameMain.java`

## 安全建议

### 1. 密钥管理

**当前实现**：硬编码密钥
```java
private static final String SECRET_KEY = "FreedomLand_Official_Launcher_v1.0.0_SecretKey";
```

**建议改进**：
- 使用配置文件存储密钥
- 使用环境变量
- 使用密钥管理系统（如Vault）
- 定期轮换密钥

### 2. 令牌加密

**当前实现**：明文传递令牌（命令行参数）

**建议改进**：
- 使用对称加密（如AES）
- 使用非对称加密（如RSA）
- 使用临时文件传递令牌（避免命令行参数暴露）

### 3. 网络验证

**当前实现**：本地验证

**建议改进**：
- 连接到认证服务器验证
- 使用OAuth或JWT
- 记录启动日志到服务器

### 4. 代码混淆

为防止逆向工程：
- 使用ProGuard或R8混淆代码
- 关键验证逻辑使用原生代码
- 使用反调试技术

## 测试

### 测试正常启动

```bash
# 通过启动器启动（应该成功）
java -jar Launcher/target/freedomland-launcher-1.0.0-jar-with-dependencies.jar
```

### 测试直接启动（应该失败）

```bash
# 直接启动游戏核心（应该失败并显示错误）
java -jar GameCore/target/freedomland-gamecore-1.0.0-jar-with-dependencies.jar
```

### 测试过期令牌

修改令牌中的时间戳，使其超过5分钟有效期，应该验证失败。

## 常见问题

### Q: 如果系统时间不准确怎么办？

A: 令牌有效期设置为5分钟，允许一定的时间偏差。如果时间偏差过大，可以：
1. 同步系统时间
2. 增加令牌有效期
3. 使用NTP服务器同步时间

### Q: 能否绕过验证？

A: 理论上可以通过逆向工程获取密钥或修改代码绕过。建议：
1. 代码混淆
2. 关键验证逻辑使用原生代码
3. 服务器端验证

### Q: 令牌泄露怎么办？

A: 令牌有时效性（5分钟），泄露的令牌会自动过期。建议：
1. 定期更新密钥
2. 记录异常启动尝试
3. 实施IP限制

---

**版本**: 1.0.0  
**最后更新**: 2025-11-15

